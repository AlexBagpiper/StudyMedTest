# Система оценки LLM для текстовых вопросов

## Максимальный балл за вопрос

**Максимальный балл = сумма всех критериев оценки**

### Дефолтные критерии (если не заданы для вопроса)

```python
{
    "factual_correctness": 40,    # Фактическая правильность
    "completeness": 30,            # Полнота ответа
    "terminology": 20,             # Терминология
    "structure": 10                # Структура изложения
}
```

**Максимум = 40 + 30 + 20 + 10 = 100 баллов**

### Кастомные критерии

При создании вопроса можно задать свои критерии через поле `scoring_criteria`:

```json
{
    "factual_correctness": 50,
    "completeness": 30,
    "terminology": 15,
    "structure": 5
}
```

В этом случае максимум = 50 + 30 + 15 + 5 = **100 баллов** (или любая другая сумма).

## Как считается total_score

### Процесс оценки

1. **LLM получает:**
   - Вопрос
   - Эталонный ответ
   - Ответ студента
   - Критерии с максимальными значениями

2. **LLM возвращает JSON:**
```json
{
    "criteria_scores": {
        "factual_correctness": 35,
        "completeness": 25,
        "terminology": 18,
        "structure": 8
    },
    "total_score": 86,
    "feedback": "Хороший ответ, но..."
}
```

3. **total_score должен быть суммой всех criteria_scores:**
   - `total_score = sum(criteria_scores.values())`
   - В примере: 35 + 25 + 18 + 8 = 86 ✓

### Важные моменты

⚠️ **Нет автоматической валидации:**
- Система не проверяет, что `total_score` равен сумме `criteria_scores`
- Если LLM вернет неверную сумму, она будет использована как есть
- В промпте указано: `"total_score": <сумма>` - LLM должен сам посчитать

⚠️ **Нет ограничения сверху:**
- Теоретически LLM может вернуть `total_score > sum(max_criteria)`
- Но на практике LLM обычно следует инструкциям и не превышает максимум

⚠️ **Нет ограничения снизу:**
- Минимум = 0 (если все критерии = 0)

## Итоговая оценка за тест

### Взвешенная система сложности

Балл за каждый вопрос умножается на коэффициент сложности:

| Сложность | Вес | Макс. взвешенных баллов |
|-----------|-----|------------------------|
| 1 (Базовый) | 1.0 | 100 |
| 2 (Понимание) | 1.5 | 150 |
| 3 (Применение) | 2.0 | 200 |
| 4 (Анализ) | 2.5 | 250 |
| 5 (Экспертный) | 3.0 | 300 |

### Формула расчета

```
P = (Σ(Балл_i × Вес_i) / Σ(100 × Вес_i)) × 100
```

Где:
- `Балл_i` - балл за вопрос i (0-100)
- `Вес_i` - коэффициент сложности вопроса i
- `P` - итоговый процент (0-100)

### Пример

**Тест из 3 вопросов:**
- Вопрос 1: сложность 1, балл 80 → взвешенный = 80 × 1.0 = 80
- Вопрос 2: сложность 2, балл 70 → взвешенный = 70 × 1.5 = 105
- Вопрос 3: сложность 3, балл 90 → взвешенный = 90 × 2.0 = 180

**Итого:**
- Сумма взвешенных: 80 + 105 + 180 = 365
- Максимум взвешенных: 100×1.0 + 100×1.5 + 100×2.0 = 450
- Процент: (365 / 450) × 100 = **81.1%**

### Шкала оценок

| Процент | Оценка |
|---------|--------|
| 90-100% | 5 (Отлично) |
| 75-89% | 4 (Хорошо) |
| 60-74% | 3 (Удовлетворительно) |
| < 60% | 2 (Неудовлетворительно) |

## Где настраивается

1. **Критерии для вопроса:**
   - При создании/редактировании вопроса
   - Поле `scoring_criteria` в форме вопроса
   - Если не задано → используются дефолты

2. **Промпт для LLM:**
   - Админ-панель → Настройки LLM → Промпт оценки
   - Поле `evaluation_prompt`
   - Если не задано → используется дефолтный промпт

3. **Сложность вопроса:**
   - При создании/редактировании вопроса
   - Поле `difficulty` (1-5)

## Код

- Дефолтные критерии: `backend/app/services/llm_service.py:573-579`
- Расчет итогового балла: `backend/app/tasks/evaluation_tasks.py:286-300`
- Формула взвешенной оценки: `backend/app/tasks/evaluation_tasks.py:290-300`
