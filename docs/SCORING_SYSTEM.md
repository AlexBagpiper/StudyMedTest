# Система оценки MedTest Platform

## 1. Уровни оценки

Система использует двухуровневую модель оценки:
1.  **Балл за вопрос (0–100)** — вычисляется автоматически на основе типа задания (Computer Vision или LLM).
2.  **Итоговая оценка за тест (2–5)** — вычисляется на основе суммы всех взвешенных баллов за ответы с учетом их сложности.

---

## 2. Оценка отдельных вопросов

### 2.1. Графические вопросы (Computer Vision)
Оценка вычисляется сервисом CV на основе сравнения аннотаций студента с эталоном.

**Метрики качества:**
- **Accuracy (W_iou)** — точность геометрии (Intersection over Union).
- **Completeness (W_recall)** — полнота (все ли объекты из эталона найдены).
- **Precision (W_precision)** — отсутствие лишних аннотаций (достоверность).

**Формула балла:**
`Question Score = (W_iou × Accuracy + W_recall × Completeness + W_precision × Precision) × 100`

*Примечание: Веса метрик настраиваются администратором в системных настройках (по умолчанию: 0.5 / 0.3 / 0.2).*

**Технические детали CV-оценки:**
- **Алгоритм IoU**: Поддержка типов rectangle, polygon, ellipse, point.
- **Асинхронность**: Обработка выполняется через Celery в очереди `cv`.
- **Библиотеки**: `shapely` для геометрии, `numpy` для метрик.

### 2.2. Текстовые ответы (LLM)
Оцениваются нейросетью (YandexGPT или локальная модель) по критериям:
- Фактическая точность.
- Полнота ответа.
- Использование медицинской терминологии.
- Логика изложения.

---

## 3. Итоговая оценка (Взвешенная сложность)

Для расчета итогового результата используется **модель взвешенной сложности (Weighted Difficulty Scoring)**. Это означает, что сложные вопросы приносят больше баллов в «копилку» общего результата, чем простые.

### 3.1. Коэффициенты сложности

Каждому вопросу при создании присваивается уровень сложности от 1 до 5.

| Сложность | Уровень | Вес (множитель) | Макс. взвешенных баллов |
| :--- | :--- | :--- | :--- |
| **1** | Базовый | 1.0 | 100 |
| **2** | Понимание | 1.5 | 150 |
| **3** | Применение | 2.0 | 200 |
| **4** | Анализ | 2.5 | 250 |
| **5** | Экспертный | 3.0 | 300 |

### 3.2. Алгоритм расчета итогового процента

1.  Балл за каждый вопрос (0-100) умножается на коэффициент сложности этого вопроса.
2.  Полученные взвешенные баллы суммируются.
3.  Сумма делится на максимально возможную сумму взвешенных баллов.
4.  Результат переводится в 100-балльную шкалу.

**Формула:**
$$P = \frac{\sum (\text{Балл}_i \times \text{Вес}_i)}{\sum (100 \times \text{Вес}_i)} \times 100$$

### 3.3. Шкала оценок

Итоговая оценка выставляется на основе полученного процента ($P$):

| Процент | Оценка | Описание |
| :--- | :--- | :--- |
| **90% – 100%** | **5** | Отлично |
| **75% – 89%** | **4** | Хорошо |
| **60% – 74%** | **3** | Удовлетворительно |
| **Менее 60%** | **2** | Неудовлетворительно |

---

## 4. Тестирование и верификация

### 4.1. Сценарии проверки CV
Для обеспечения точности CV-оценки используются следующие тестовые сценарии:
1. **Идеальное совпадение**: Копия эталона → 100 баллов.
2. **Смещение**: Смещение на 20% → ~83 балла.
3. **Лишние объекты**: Снижение Precision → ~90 баллов.
4. **Пропуски**: Снижение Completeness → ~85 баллов.

### 4.2. Ручной пересчет
Администратор может инициировать пересчет всей работы (revaluate) при изменении системных весов или исправлении эталона.

---

## 5. Округление
Все промежуточные баллы и итоговый процент округляются до **ближайшего целого числа**.
