import React, { createContext, useContext, useState, useCallback } from 'react'

export type Locale = 'ru' | 'en'

// Переводы
const translations = {
  ru: {
    // Роли
    'role.admin': 'Администратор',
    'role.teacher': 'Преподаватель',
    'role.student': 'Студент',
    
    // Навигация
    'nav.dashboard': 'Главная',
    'nav.tests': 'Тесты',
    'nav.questions': 'Вопросы',
    'nav.submissions': 'Результаты',
    'nav.profile': 'Профиль',
    'nav.logout': 'Выйти',
    'nav.admin': 'Админ-панель',
    'nav.topics': 'Темы',
    'nav.mail': 'Почта',
    'nav.mailAdmin': 'Почта (Админ)',
    
    // Авторизация
    'auth.login': 'Войти',
    'auth.register': 'Зарегистрироваться',
    'auth.email': 'Email',
    'auth.password': 'Пароль',
    'auth.lastName': 'Фамилия',
    'auth.firstName': 'Имя',
    'auth.middleName': 'Отчество',
    'auth.noAccount': 'Нет аккаунта?',
    'auth.hasAccount': 'Уже есть аккаунт?',
    'auth.loading': 'Загрузка...',
    'auth.registering': 'Регистрация...',
    'auth.passwordMin': 'Минимум 6 символов',
    'auth.confirmPassword': 'Подтвердите пароль',
    'auth.passwordsDontMatch': 'Пароли не совпадают',
    'auth.enterLastName': 'Введите фамилию',
    'auth.enterFirstName': 'Введите имя',
    'auth.invalidCredentials': 'Неверный email или пароль',
    'auth.userNotFound': 'Пользователь не найден',
    'auth.accountInactive': 'Аккаунт деактивирован',
    'auth.loginError': 'Ошибка входа. Проверьте данные.',
    'auth.networkError': 'Ошибка сети. Сервер недоступен.',
    
    // Профиль
    'profile.title': 'Профиль',
    'profile.edit': 'Редактировать профиль',
    'profile.save': 'Сохранить',
    'profile.cancel': 'Отмена',
    'profile.changePassword': 'Изменить пароль',
    'profile.currentPassword': 'Текущий пароль',
    'profile.newPassword': 'Новый пароль',
    'profile.confirmPassword': 'Подтвердите пароль',
    'profile.passwordMismatch': 'Пароли не совпадают',
    'profile.saved': 'Профиль сохранён',
    'profile.passwordChanged': 'Пароль изменён',
    'profile.editDescription': 'Здесь вы можете изменить свои данные',
    'profile.emailReadonly': 'Email нельзя изменить',
    'profile.changeEmail': 'Изменить email',
    'profile.newEmail': 'Новый email',
    'profile.sendCode': 'Отправить код',
    'profile.enterCode': 'Введите код из письма',
    'profile.codeSent': 'Код отправлен на',
    'profile.confirmCode': 'Подтвердить',
    'profile.emailChanged': 'Email успешно изменён',
    'profile.codeExpired': 'Код истёк, запросите новый',
    'profile.invalidCode': 'Неверный код',
    'profile.emailAlreadyRegistered': 'Этот email уже зарегистрирован',
    'profile.noPendingRequest': 'Нет активного запроса на смену email',
    
    // Dashboard
    'dashboard.welcome.admin': 'Добро пожаловать, администратор!',
    'dashboard.welcome.teacher': 'Добро пожаловать, преподаватель!',
    'dashboard.welcome.student': 'Добро пожаловать, студент!',
    'dashboard.welcome.default': 'Добро пожаловать!',
    'dashboard.availableTests': 'Доступные тесты',
    'dashboard.takeTest': 'Пройдите новый тест',
    'dashboard.myResults': 'Мои результаты',
    'dashboard.viewResults': 'Просмотрите ваши результаты',
    'dashboard.createTest': 'Создать тест',
    'dashboard.createTestDesc': 'Создайте новый тест для студентов',
    'dashboard.createQuestion': 'Создать вопрос',
    'dashboard.createQuestionDesc': 'Добавьте новый вопрос в базу',
    'dashboard.studentResults': 'Результаты студентов',
    'dashboard.studentResultsDesc': 'Просмотрите результаты тестов',
    'dashboard.go': 'Перейти',
    'dashboard.statistics': 'Статистика',
    'dashboard.statisticsDesc': 'Здесь будет отображаться статистика и аналитика',
    
    // Общие
    'common.loading': 'Загрузка...',
    'common.error': 'Ошибка',
    'common.success': 'Успешно',
    'common.save': 'Сохранить',
    'common.cancel': 'Отмена',
    'common.delete': 'Удалить',
    'common.edit': 'Редактировать',
    'common.back': 'Назад',
    'common.next': 'Далее',
    'common.notFound': '404 - Страница не найдена',
    'common.language': 'Язык',
    'common.confirm': 'Подтвердить',
    'common.ok': 'OK',
    'common.help': 'Справка',
    
    // Wiki
    'wiki.AdminGuide': 'Руководство администратора',
    'wiki.TeacherGuide': 'Руководство преподавателя',
    'wiki.StudentGuide': 'Руководство студента',
    'wiki.ScoringMethodology': 'Методология оценки',
    'wiki.FAQ': 'Частые вопросы (FAQ)',
    'wiki.Home': 'Главная',
    'wiki.Roles': 'Роли и права',
    
    // Админ-панель
    'admin.title': 'Админ-панель',
    'admin.stats': 'Статистика',
    'admin.users': 'Пользователи',
    'admin.questions': 'Вопросы',
    'admin.tests': 'Тесты',
    'admin.submissions': 'Результаты',
    'admin.images': 'Изображения',
    'admin.auditLogs': 'Журнал действий',
    'admin.totalUsers': 'Всего пользователей',
    'admin.students': 'Студенты',
    'admin.teachers': 'Преподаватели',
    'admin.admins': 'Администраторы',
    'admin.publishedTests': 'Опубликованные тесты',
    'admin.completedSubmissions': 'Завершённые результаты',
    'admin.search': 'Поиск...',
    'admin.role': 'Роль',
    'admin.all': 'Все',
    'admin.addUser': 'Добавить пользователя',
    'admin.name': 'ФИО',
    'admin.status': 'Статус',
    'admin.createdAt': 'Создан',
    'admin.actions': 'Действия',
    'admin.active': 'Активен',
    'admin.inactive': 'Неактивен',
    'admin.verified': 'Подтверждён',
    'admin.rowsPerPage': 'Строк на странице',
    'admin.itemTitle': 'Название',
    'admin.type': 'Тип',
    'admin.author': 'Автор',
    'admin.content': 'Содержание',
    'admin.description': 'Описание',
    'admin.draft': 'Черновик',
    'admin.published': 'Опубликован',
    'admin.archived': 'В архиве',
    'admin.student': 'Студент',
    'admin.test': 'Тест',
    'admin.score': 'Баллы',
    'admin.startedAt': 'Начат',
    'admin.filename': 'Имя файла',
    'admin.dimensions': 'Размеры',
    'admin.size': 'Размер',
    'admin.user': 'Пользователь',
    'admin.action': 'Действие',
    'admin.resourceType': 'Тип ресурса',
    'admin.timestamp': 'Время',
    'admin.create': 'Создать',
    'admin.confirmDelete': 'Подтверждение удаления',
    'admin.deleteConfirmMessage': 'Вы уверены, что хотите удалить',

    // Темы
    'topics.title': 'Темы',
    'topics.create': 'Создать тему',
    'topics.edit': 'Редактировать тему',
    'topics.delete': 'Удалить тему',
    'topics.noTopics': 'Темы отсутствуют',
    'topics.createFirst': 'Создать первую тему',
    'topics.name': 'Название темы',
    'topics.description': 'Описание',
    'topics.deleteConfirm': 'Вы уверены, что хотите удалить эту тему?',
    'topics.saving': 'Сохранение...',
    'topics.update': 'Обновить',
    'topics.error.deleteWithQuestions': 'Нельзя удалить тему, к которой привязаны вопросы',
    'topics.error.alreadyExists': 'Тема с таким названием уже существует',
    'topics.error.notFound': 'Тема не найдена',
    'topics.accessDenied': 'Доступ запрещен',
    'topics.accessDeniedDesc': 'Студенты не имеют доступа к этой странице.',
    'topics.loadError': 'Ошибка загрузки тем',
    'topics.error.noAnnotations': 'В файле не найдены аннотации для изображения "{filename}". Убедитесь, что "file_name" в JSON совпадает с именем загруженного изображения.',
    'questions.error.mustBeJson': 'Файл аннотаций должен быть в формате JSON',
    'questions.error.invalidJson': 'Некорректный JSON в файле аннотаций',
    'questions.error.imageNotFound': 'Изображение не найдено',

    // Ошибки
    'error.notEnoughPermissions': 'Недостаточно прав',
    'error.unexpected': 'Произошла непредвиденная ошибка',

    // Вопросы
    'questions.title': 'Вопросы',
    'questions.create': 'Создать вопрос',
    'questions.edit': 'Редактировать вопрос',
    'questions.view': 'Просмотр вопроса',
    'questions.type': 'Тип вопроса',
    'questions.type.text': 'Текстовый ответ',
    'questions.type.imageAnnotation': 'Графическая аннотация',
    'questions.topic': 'Тема',
    'questions.noTopic': 'Без темы',
    'questions.content': 'Текст вопроса',
    'questions.referenceAnswer': 'Эталонный ответ',
    'questions.referenceAnswerDesc': 'Ответ, с которым будут сравниваться ответы студентов',
    'questions.imageAnnotationInfo': 'Для графических вопросов студенты будут размечать изображения. Загрузка изображений пока не реализована - будет добавлена позже.',
    'questions.enterContent': 'Введите текст вопроса',
    'questions.enterAnswer': 'Введите ответ',
    'questions.enterReferenceAnswer': 'Введите эталонный ответ',
    'questions.difficulty': 'Сложность',
    'questions.selectType': 'Выберите тип вопроса',
    'questions.bank': 'Банк вопросов',
    'questions.searchPlaceholder': 'Поиск по названию или содержанию...',
    'questions.allTopics': 'Все темы',
    'questions.allTypes': 'Все типы',
    'questions.emptyBank': 'Банк вопросов пуст',
    'questions.noResults': 'Вопросы не найдены',
    'questions.createFirst': 'Создать первый вопрос',
    'questions.date': 'Дата',
    'questions.deleteConfirm': 'Вы уверены, что хотите удалить этот вопрос?',
    'questions.viewTitle': 'Просмотр',
    'questions.duplicateTitle': 'Дублировать',
    'questions.editTitle': 'Редактировать',
    'questions.deleteTitle': 'Удалить',
    'questions.adminReadOnly': 'Вопрос администратора (только чтение)',
    'questions.uploadImageAndAnnotations': 'Загрузите изображение и файл аннотаций',
    'questions.annotationsLoaded': 'Аннотации загружены',
    'questions.imageRequired': 'Изображение обязательно',
    'questions.selectImageAndAnnotations': 'Пожалуйста, выберите изображение вместе с файлом аннотаций',
    'questions.supportedFormats': 'Поддерживаются JPG, PNG и JSON (COCO format)',
    'questions.uploading': 'Загрузка...',
    'questions.chooseFiles': 'Выбрать файлы',
    'questions.annotationsRequired': 'Для графического вопроса наличие аннотаций обязательно',
    'questions.uploadAnnotations': 'Загрузить аннотации (JSON)',
    'questions.imageUploadedAnnotationsRejected': 'Изображение загружено, но файл аннотаций отклонен: {error}',
    'questions.backToForm': 'Вернуться к форме',
    'questions.uploadJson': 'Загрузить JSON',
    'questions.manualAnnotation': 'Ручная разметка',
    'questions.noAnnotations': 'Аннотации отсутствуют',
    'questions.annotationsSummary': 'Метки: {labels}, Области: {annotations}',
    'questions.openEditor': 'Открыть редактор разметки',
    'questions.viewAnnotation': 'Просмотреть разметку',
    'questions.atLeastOneAnnotation': 'Необходимо разметить хотя бы одну область',
    'questions.allowPartial': 'Разрешить частичное выделение (для сложных контуров)',
    
    // Тесты
    'tests.title.student': 'Доступные тесты',
    'tests.title.admin': 'Управление тестами',
    'tests.create': 'Создать тест',
    'tests.createFirst': 'Создать первый тест',
    'tests.noTests.student': 'Нет доступных тестов',
    'tests.noTests.admin': 'У вас пока нет тестов',
    'tests.error.load': 'Ошибка загрузки тестов',
    'tests.error.unknown': 'Неизвестная ошибка',
    'tests.description.empty': 'Описание отсутствует',
    'tests.error.noQuestions': 'Необходимо выбрать хотя бы один вопрос или настроить структуру',
    'submissions.loading': 'Загрузка...',
    'topics.nameRequired': 'Название темы обязательно',
    'tests.questionsCount': '{count} вопросов',
    'tests.timeLimit': '{count} мин',
    'tests.status.draft': 'Черновик',
    'tests.status.published': 'Опубликован',
    'tests.status.archived': 'Архивирован',
    'tests.submission.inProgress': 'В процессе',
    'tests.submission.evaluating': 'На проверке',
    'tests.submission.completed': 'Завершено',
    'tests.action.start': 'Начать тест',
    'tests.action.continue': 'Продолжить',
    'tests.action.completed': 'Завершено',
    'tests.action.view': 'Просмотр',
    'tests.action.duplicate': 'Дублировать',
    'tests.action.publish': 'Опубликовать',
    'tests.action.unpublish': 'Снять с публикации',
    'tests.adminReadOnly': 'Тест администратора (только чтение)',
    'tests.confirm.publish': 'Опубликовать тест? Студенты смогут его видеть.',
    'tests.confirm.unpublish': 'Снять тест с публикации? Студенты больше не смогут его видеть.',
    'tests.confirm.duplicate': 'Создать копию этого теста? Вы станете автором копии.',
    'tests.confirm.delete': 'Вы уверены, что хотите удалить этот тест?',
    'tests.confirm.start.title': 'Начать тест?',
    'tests.confirm.start.content': 'Вы уверены, что хотите приступить к выполнению теста?',
    'tests.confirm.finish.title': 'Завершить тест?',
    'tests.confirm.finish.content': 'Вы уверены, что хотите завершить тест? После этого вы не сможете изменить свои ответы.',
    'tests.confirm.finish.confirmText': 'Завершить тест',
    'tests.confirm.timeExpired.title': 'Время истекло',
    'tests.confirm.timeExpired.content': 'Время на выполнение теста закончилось. Ваши ответы были сохранены и тест отправлен на проверку.',
    'tests.questionIndex': 'Вопрос {current} из {total}',
    'tests.timeLeft': 'Осталось',
    'tests.backToTests': 'Назад к тестам',
    
    // Результаты (Submissions)
    'submissions.title.my': 'Мои результаты',
    'submissions.title.all': 'Результаты студентов',
    'submissions.noResults.my': 'У вас пока нет завершенных тестов',
    'submissions.noResults.all': 'Нет результатов для отображения',
    'submissions.error.load': 'Ошибка загрузки результатов',
    'submissions.error.delete': 'Не удалось удалить попытку',
    'submissions.confirm.delete': 'Вы уверены, что хотите удалить эту попытку?',
    'submissions.table.student': 'Студент',
    'submissions.table.teacher': 'Преподаватель',
    'submissions.table.test': 'Тест',
    'submissions.table.date': 'Дата начала',
    'submissions.table.status': 'Статус',
    'submissions.table.result': 'Результат',
    'submissions.table.actions': 'Действие',
    'submissions.action.details': 'Просмотр',
    'submissions.action.delete': 'Удалить попытку',
    'submissions.status.inProgress': 'В процессе',
    'submissions.status.evaluating': 'На проверке',
    'submissions.status.completed': 'Завершено',
    'submissions.status.submitted': 'Отправлено',
    'submissions.showHidden': 'Показать скрытые результаты',
    'submissions.action.hide': 'Скрыть',
    'submissions.action.restore': 'Восстановить',
    'submissions.hidden': 'Скрыто',
    'tests.fixedQuestions': 'фикс. вопросов',
    'tests.dynamicQuestions': 'динам. вопросов',
    'tests.settings': 'Настройки',
    'tests.info': 'Информация',
    'tests.createdAt': 'Создано',
    'tests.publishedAt': 'Опубликовано',
    'tests.structure': 'Структура автоподбора вопросов',
    'tests.fixedTitle': 'Фиксированные вопросы',
    'tests.topic': 'Тема',
    'tests.type': 'Тип',
    'tests.count': 'Кол-во',
    'tests.difficulty': 'Сложность',
    'tests.timeLimitDesc': 'Время на прохождение: {count} минут',
  },
  en: {
    // Roles
    'role.admin': 'Administrator',
    'role.teacher': 'Teacher',
    'role.student': 'Student',
    
    // Navigation
    'nav.dashboard': 'Dashboard',
    'nav.tests': 'Tests',
    'nav.questions': 'Questions',
    'nav.submissions': 'Submissions',
    'nav.profile': 'Profile',
    'nav.logout': 'Logout',
    'nav.admin': 'Admin Panel',
    'nav.topics': 'Topics',
    'nav.mail': 'Mail',
    'nav.mailAdmin': 'Mail (Admin)',
    
    // Auth
    'auth.login': 'Login',
    'auth.register': 'Register',
    'auth.email': 'Email',
    'auth.password': 'Password',
    'auth.lastName': 'Last Name',
    'auth.firstName': 'First Name',
    'auth.middleName': 'Middle Name',
    'auth.noAccount': "Don't have an account?",
    'auth.hasAccount': 'Already have an account?',
    'auth.loading': 'Loading...',
    'auth.registering': 'Registering...',
    'auth.passwordMin': 'Minimum 6 characters',
    'auth.confirmPassword': 'Confirm Password',
    'auth.passwordsDontMatch': 'Passwords do not match',
    'auth.enterLastName': 'Enter last name',
    'auth.enterFirstName': 'Enter first name',
    'auth.invalidCredentials': 'Invalid email or password',
    'auth.userNotFound': 'User not found',
    'auth.accountInactive': 'Account is deactivated',
    'auth.loginError': 'Login error. Check your credentials.',
    'auth.networkError': 'Network error. Server unavailable.',
    
    // Profile
    'profile.title': 'Profile',
    'profile.edit': 'Edit Profile',
    'profile.save': 'Save',
    'profile.cancel': 'Cancel',
    'profile.changePassword': 'Change Password',
    'profile.currentPassword': 'Current Password',
    'profile.newPassword': 'New Password',
    'profile.confirmPassword': 'Confirm Password',
    'profile.passwordMismatch': 'Passwords do not match',
    'profile.saved': 'Profile saved',
    'profile.passwordChanged': 'Password changed',
    'profile.editDescription': 'Here you can edit your information',
    'profile.emailReadonly': 'Email cannot be changed',
    'profile.changeEmail': 'Change email',
    'profile.newEmail': 'New email',
    'profile.sendCode': 'Send code',
    'profile.enterCode': 'Enter code from email',
    'profile.codeSent': 'Code sent to',
    'profile.confirmCode': 'Confirm',
    'profile.emailChanged': 'Email changed successfully',
    'profile.codeExpired': 'Code expired, request a new one',
    'profile.invalidCode': 'Invalid code',
    'profile.emailAlreadyRegistered': 'This email is already registered',
    'profile.noPendingRequest': 'No pending email change request',
    
    // Dashboard
    'dashboard.welcome.admin': 'Welcome, Administrator!',
    'dashboard.welcome.teacher': 'Welcome, Teacher!',
    'dashboard.welcome.student': 'Welcome, Student!',
    'dashboard.welcome.default': 'Welcome!',
    'dashboard.availableTests': 'Available Tests',
    'dashboard.takeTest': 'Take a new test',
    'dashboard.myResults': 'My Results',
    'dashboard.viewResults': 'View your results',
    'dashboard.createTest': 'Create Test',
    'dashboard.createTestDesc': 'Create a new test for students',
    'dashboard.createQuestion': 'Create Question',
    'dashboard.createQuestionDesc': 'Add a new question to the database',
    'dashboard.studentResults': 'Student Results',
    'dashboard.studentResultsDesc': 'View test results',
    'dashboard.go': 'Go',
    'dashboard.statistics': 'Statistics',
    'dashboard.statisticsDesc': 'Statistics and analytics will be displayed here',
    
    // Common
    'common.loading': 'Loading...',
    'common.error': 'Error',
    'common.success': 'Success',
    'common.save': 'Save',
    'common.cancel': 'Cancel',
    'common.delete': 'Delete',
    'common.edit': 'Edit',
    'common.back': 'Back',
    'common.next': 'Next',
    'common.notFound': '404 - Page not found',
    'common.language': 'Language',
    'common.confirm': 'Confirm',
    'common.ok': 'OK',
    'common.help': 'Help',

    // Wiki
    'wiki.AdminGuide': 'Administrator Guide',
    'wiki.TeacherGuide': 'Teacher Guide',
    'wiki.StudentGuide': 'Student Guide',
    'wiki.ScoringMethodology': 'Scoring Methodology',
    'wiki.FAQ': 'FAQ',
    'wiki.Home': 'Home',
    'wiki.Roles': 'Roles and Permissions',
    
    // Admin Panel
    'admin.title': 'Admin Panel',
    'admin.stats': 'Statistics',
    'admin.users': 'Users',
    'admin.questions': 'Questions',
    'admin.tests': 'Tests',
    'admin.submissions': 'Submissions',
    'admin.images': 'Images',
    'admin.auditLogs': 'Audit Logs',
    'admin.totalUsers': 'Total Users',
    'admin.students': 'Students',
    'admin.teachers': 'Teachers',
    'admin.admins': 'Admins',
    'admin.publishedTests': 'Published Tests',
    'admin.completedSubmissions': 'Completed Submissions',
    'admin.search': 'Search...',
    'admin.role': 'Role',
    'admin.all': 'All',
    'admin.addUser': 'Add User',
    'admin.name': 'Name',
    'admin.status': 'Status',
    'admin.createdAt': 'Created',
    'admin.actions': 'Actions',
    'admin.active': 'Active',
    'admin.inactive': 'Inactive',
    'admin.verified': 'Verified',
    'admin.rowsPerPage': 'Rows per page',
    'admin.itemTitle': 'Title',
    'admin.type': 'Type',
    'admin.author': 'Author',
    'admin.content': 'Content',
    'admin.description': 'Description',
    'admin.draft': 'Draft',
    'admin.published': 'Published',
    'admin.archived': 'Archived',
    'admin.student': 'Student',
    'admin.test': 'Test',
    'admin.score': 'Score',
    'admin.startedAt': 'Started',
    'admin.filename': 'Filename',
    'admin.dimensions': 'Dimensions',
    'admin.size': 'Size',
    'admin.user': 'User',
    'admin.action': 'Action',
    'admin.resourceType': 'Resource Type',
    'admin.timestamp': 'Timestamp',
    'admin.create': 'Create',
    'admin.confirmDelete': 'Confirm Delete',
    'admin.deleteConfirmMessage': 'Are you sure you want to delete',

    // Topics
    'topics.title': 'Topics',
    'topics.create': 'Create Topic',
    'topics.edit': 'Edit Topic',
    'topics.delete': 'Delete Topic',
    'topics.noTopics': 'No topics',
    'topics.createFirst': 'Create first topic',
    'topics.name': 'Topic Name',
    'topics.description': 'Description',
    'topics.deleteConfirm': 'Are you sure you want to delete this topic?',
    'topics.saving': 'Saving...',
    'topics.update': 'Update',
    'topics.error.deleteWithQuestions': 'Cannot delete topic with associated questions',
    'topics.error.alreadyExists': 'Topic with this name already exists',
    'topics.error.notFound': 'Topic not found',
    'topics.accessDenied': 'Access Denied',
    'topics.accessDeniedDesc': 'Students do not have access to this page.',
    'topics.loadError': 'Error loading topics',
    'topics.error.noAnnotations': 'No annotations found for image "{filename}" in the provided file. Make sure "file_name" in JSON matches the uploaded image name.',
    'questions.error.mustBeJson': 'Annotations file must be a JSON file',
    'questions.error.invalidJson': 'Invalid JSON in annotations file',
    'questions.error.imageNotFound': 'Image not found',

    // Errors
    'error.notEnoughPermissions': 'Not enough permissions',
    'error.unexpected': 'An unexpected error occurred',

    // Questions
    'questions.title': 'Questions',
    'questions.create': 'Create Question',
    'questions.edit': 'Edit Question',
    'questions.view': 'View Question',
    'questions.type': 'Question Type',
    'questions.type.text': 'Text Answer',
    'questions.type.imageAnnotation': 'Image Annotation',
    'questions.topic': 'Topic',
    'questions.noTopic': 'No Topic',
    'questions.content': 'Question Content',
    'questions.referenceAnswer': 'Reference Answer',
    'questions.referenceAnswerDesc': 'The answer that student answers will be compared to',
    'questions.imageAnnotationInfo': 'For image questions, students will annotate images. Image uploading is not yet implemented - it will be added later.',
    'questions.enterContent': 'Enter question content',
    'questions.enterAnswer': 'Enter your answer',
    'questions.enterReferenceAnswer': 'Enter reference answer',
    'questions.difficulty': 'Difficulty',
    'questions.selectType': 'Select question type',
    'questions.bank': 'Question Bank',
    'questions.searchPlaceholder': 'Search by content...',
    'questions.allTopics': 'All Topics',
    'questions.allTypes': 'All Types',
    'questions.emptyBank': 'Question bank is empty',
    'questions.noResults': 'No questions found',
    'questions.createFirst': 'Create first question',
    'questions.date': 'Date',
    'questions.deleteConfirm': 'Are you sure you want to delete this question?',
    'questions.viewTitle': 'View',
    'questions.duplicateTitle': 'Duplicate',
    'questions.editTitle': 'Edit',
    'questions.deleteTitle': 'Delete',
    'questions.adminReadOnly': 'Question from Admin (Read Only)',
    'questions.uploadImageAndAnnotations': 'Upload image and annotation file',
    'questions.annotationsLoaded': 'Annotations loaded',
    'questions.imageRequired': 'Image is required',
    'questions.selectImageAndAnnotations': 'Please select an image along with the annotation file',
    'questions.supportedFormats': 'Supported formats: JPG, PNG and JSON (COCO format)',
    'questions.uploading': 'Uploading...',
    'questions.chooseFiles': 'Choose files',
    'questions.annotationsRequired': 'Annotations are required for image questions',
    'questions.uploadAnnotations': 'Upload annotations (JSON)',
    'questions.imageUploadedAnnotationsRejected': 'Image uploaded, but annotations file rejected: {error}',
    'questions.backToForm': 'Back to form',
    'questions.uploadJson': 'Upload JSON',
    'questions.manualAnnotation': 'Manual annotation',
    'questions.noAnnotations': 'No annotations',
    'questions.annotationsSummary': 'Labels: {labels}, Annotations: {annotations}',
    'questions.openEditor': 'Open annotation editor',
    'questions.viewAnnotation': 'View annotation',
    'questions.atLeastOneAnnotation': 'At least one annotation is required',
    'questions.allowPartial': 'Allow partial annotation (for complex shapes)',

    // Tests
    'tests.title.student': 'Available Tests',
    'tests.title.admin': 'Test Management',
    'tests.create': 'Create Test',
    'tests.createFirst': 'Create first test',
    'tests.noTests.student': 'No tests available',
    'tests.noTests.admin': 'You have no tests yet',
    'tests.error.load': 'Error loading tests',
    'tests.error.unknown': 'Unknown error',
    'tests.description.empty': 'No description',
    'tests.error.noQuestions': 'You must select at least one question or configure the structure',
    'submissions.loading': 'Loading...',
    'topics.nameRequired': 'Topic name is required',
    'tests.questionsCount': '{count} questions',
    'tests.timeLimit': '{count} min',
    'tests.status.draft': 'Draft',
    'tests.status.published': 'Published',
    'tests.status.archived': 'Archived',
    'tests.submission.inProgress': 'In Progress',
    'tests.submission.evaluating': 'Evaluating',
    'tests.submission.completed': 'Completed',
    'tests.action.start': 'Start Test',
    'tests.action.continue': 'Continue',
    'tests.action.completed': 'Completed',
    'tests.action.view': 'View',
    'tests.action.duplicate': 'Duplicate',
    'tests.action.publish': 'Publish',
    'tests.action.unpublish': 'Unpublish',
    'tests.adminReadOnly': 'Test from Admin (Read Only)',
    'tests.confirm.publish': 'Publish test? Students will be able to see it.',
    'tests.confirm.unpublish': 'Unpublish test? Students will no longer be able to see it.',
    'tests.confirm.duplicate': 'Duplicate this test? You will become the author of the copy.',
    'tests.confirm.delete': 'Are you sure you want to delete this test?',
    'tests.confirm.start.title': 'Start test?',
    'tests.confirm.start.content': 'Are you sure you want to proceed with the test?',
    'tests.confirm.finish.title': 'Finish test?',
    'tests.confirm.finish.content': 'Are you sure you want to finish the test? You won\'t be able to change your answers after this.',
    'tests.confirm.finish.confirmText': 'Finish test',
    'tests.confirm.timeExpired.title': 'Time is up',
    'tests.confirm.timeExpired.content': 'The time for the test has expired. Your answers have been saved and the test has been submitted for evaluation.',
    'tests.questionIndex': 'Question {current} of {total}',
    'tests.timeLeft': 'Time left',
    'tests.backToTests': 'Back to tests',

    // Submissions
    'submissions.title.my': 'My Results',
    'submissions.title.all': 'Student Results',
    'submissions.noResults.my': 'You have no completed tests yet',
    'submissions.noResults.all': 'No results to display',
    'submissions.error.load': 'Error loading results',
    'submissions.error.delete': 'Failed to delete submission',
    'submissions.confirm.delete': 'Are you sure you want to delete this submission?',
    'submissions.table.student': 'Student',
    'submissions.table.teacher': 'Teacher',
    'submissions.table.test': 'Test',
    'submissions.table.date': 'Start Date',
    'submissions.table.status': 'Status',
    'submissions.table.result': 'Result',
    'submissions.table.actions': 'Action',
    'submissions.action.details': 'View',
    'submissions.action.delete': 'Delete submission',
    'submissions.status.inProgress': 'In Progress',
    'submissions.status.evaluating': 'Evaluating',
    'submissions.status.completed': 'Completed',
    'submissions.status.submitted': 'Submitted',
    'submissions.showHidden': 'Show hidden results',
    'submissions.action.hide': 'Hide',
    'submissions.action.restore': 'Restore',
    'submissions.hidden': 'Hidden',
    'tests.fixedQuestions': 'fixed questions',
    'tests.dynamicQuestions': 'dynamic questions',
    'tests.settings': 'Settings',
    'tests.info': 'Information',
    'tests.createdAt': 'Created',
    'tests.publishedAt': 'Published',
    'tests.structure': 'Question generation structure',
    'tests.fixedTitle': 'Fixed questions',
    'tests.topic': 'Topic',
    'tests.type': 'Type',
    'tests.count': 'Count',
    'tests.difficulty': 'Difficulty',
    'tests.timeLimitDesc': 'Time limit: {count} minutes',
  },
}

type TranslationKey = keyof typeof translations.ru

interface LocaleContextType {
  locale: Locale
  setLocale: (locale: Locale) => void
  t: (key: TranslationKey) => string
  translateError: (detail: any) => string
  formatName: (lastName: string, firstName: string, middleName?: string | null) => string
  formatRole: (role: string) => string
}

const LocaleContext = createContext<LocaleContextType | undefined>(undefined)

const LOCALE_STORAGE_KEY = 'app_locale'

export function LocaleProvider({ children }: { children: React.ReactNode }) {
  const [locale, setLocaleState] = useState<Locale>(() => {
    const saved = localStorage.getItem(LOCALE_STORAGE_KEY)
    return (saved as Locale) || 'ru'
  })

  const setLocale = useCallback((newLocale: Locale) => {
    setLocaleState(newLocale)
    localStorage.setItem(LOCALE_STORAGE_KEY, newLocale)
  }, [])

  const t = useCallback((key: TranslationKey): string => {
    return translations[locale][key] || key
  }, [locale])

  // Перевод ошибок API
  const translateError = useCallback((detail: any): string => {
    if (typeof detail !== 'string') {
      return translations[locale]['common.error'] || 'Error'
    }

    const errorMap: Record<string, TranslationKey> = {
      'Not enough permissions': 'error.notEnoughPermissions',
      'Topic with this name already exists': 'topics.error.alreadyExists',
      'Topic not found': 'topics.error.notFound',
      'Cannot delete topic with associated questions': 'topics.error.deleteWithQuestions',
      'Incorrect email or password': 'auth.invalidCredentials',
      'User not found': 'auth.userNotFound',
      'Inactive user': 'auth.accountInactive',
      'Email already registered': 'profile.emailAlreadyRegistered',
      'Annotations file must be a JSON file': 'questions.error.mustBeJson',
      'Invalid JSON in annotations file': 'questions.error.invalidJson',
      'Image not found': 'questions.error.imageNotFound',
    }

    // Проверка на динамические сообщения
    if (detail.includes('No annotations found for image')) {
      const match = detail.match(/'([^']+)'/)
      const filename = match ? match[1] : 'unknown'
      return translations[locale]['topics.error.noAnnotations'].replace('{filename}', filename)
    }

    const key = errorMap[detail]
    if (key && translations[locale][key]) {
      return translations[locale][key]
    }

    return detail
  }, [locale])

  // Форматирование ФИО: "Фамилия И.О." или "LastName F.M."
  const formatName = useCallback((lastName: string, firstName: string, middleName?: string | null): string => {
    const firstInitial = firstName ? firstName.charAt(0).toUpperCase() + '.' : ''
    const middleInitial = middleName ? middleName.charAt(0).toUpperCase() + '.' : ''
    
    return `${lastName} ${firstInitial}${middleInitial}`.trim()
  }, [])

  // Форматирование роли на текущем языке
  const formatRole = useCallback((role: string): string => {
    const roleKey = `role.${role}` as TranslationKey
    return translations[locale][roleKey] || role
  }, [locale])

  const value = {
    locale,
    setLocale,
    t,
    translateError,
    formatName,
    formatRole,
  }

  return <LocaleContext.Provider value={value}>{children}</LocaleContext.Provider>
}

export function useLocale() {
  const context = useContext(LocaleContext)
  if (context === undefined) {
    throw new Error('useLocale must be used within a LocaleProvider')
  }
  return context
}
